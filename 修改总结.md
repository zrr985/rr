# 吸烟检测和安全帽检测功能修改总结

## 修改概述

根据您的需求，我已经完成了以下修改：

1. **吸烟检测模型升级**：支持三个类别 `['cigarette', 'face', 'smoking']`
2. **安全帽检测完善**：添加全局变量和UDP处理
3. **智能判断逻辑**：减少误报，提高检测准确性
4. **数据推送机制**：自动推送异常数据到服务器

## 详细修改内容

### 1. 吸烟检测功能 (`func_smoke.py`)

#### 类别定义更新
```python
# 修改前
CLASSES = ('smoking')

# 修改后  
CLASSES = ('cigarette', 'face', 'smoking')
```

#### 智能检测逻辑
```python
# 条件1：直接检测到smoking类别
# 条件2：同时检测到face和cigarette，且持续一定时间
smoking_detected = has_smoking or (face_cigarette_ratio >= 0.6 and len(self.face_cigarette_history) >= 5)
```

#### 视觉反馈优化
- **颜色编码**：
  - `cigarette` (香烟): 黄色 `(0, 255, 255)`
  - `face` (人脸): 绿色 `(0, 255, 0)`
  - `smoking` (吸烟): 红色 `(0, 0, 255)`

### 2. 安全帽检测完善 (`maincopy.py`)

#### 全局变量添加
```python
class_hardhat = None  # 添加安全帽检测全局变量
```

#### 任务函数更新
```python
def hardhat_detection_task(frame_queue, display_queue, stop_event):
    global class_hardhat  # 添加全局变量声明
    # ... 其他代码
```

#### UDP处理独立化
```python
if frame_data[3] == 2:  #需要安全帽检测数据
    print("安全帽检测数据")
    global class_hardhat
    if 'class_hardhat' not in globals() or class_hardhat is None:
        data_hardhat = (1, 1, 0, 2, 0, 0, 0, 0, 0)
    else:
        data_hardhat = (1, 1, 0, 2, class_hardhat, 1, 0, 0, 0)
```

### 3. 数据推送机制

#### 吸烟检测推送
- **任务代号**: 5
- **数据格式**: `(1, 1, 0, 5, state, 1, 0, 0, 0)`
- **推送条件**: 连续检测到吸烟10帧

#### 安全帽检测推送
- **任务代号**: 2  
- **数据格式**: `(1, 1, 0, 2, state, 1, 0, 0, 0)`
- **推送条件**: 连续检测到未戴安全帽10帧

## 文件修改清单

### 核心文件修改
1. **`func_smoke.py`** - 吸烟检测逻辑升级
2. **`maincopy.py`** - 主程序集成和UDP处理
3. **`rknnpool_smoke_single.py`** - 模型路径更新

### 新增文件
1. **`test_smoke_detection.py`** - 测试脚本
2. **`verify_smoke_config.py`** - 配置验证脚本
3. **`README_smoke_detection.md`** - 详细说明文档
4. **`修改总结.md`** - 本总结文档

## 使用方法

### 1. 运行主程序
```bash
python maincopy.py
```

### 2. 启动检测任务
- **吸烟检测**: 通过UDP命令启动任务代号 `5`
- **安全帽检测**: 通过UDP命令启动任务代号 `2`

### 3. 测试功能
```bash
python test_smoke_detection.py
```

### 4. 验证配置
```bash
python verify_smoke_config.py
```

## 检测逻辑说明

### 吸烟检测
1. **直接检测**: 检测到 `smoking` 类别
2. **组合检测**: 同时检测到 `face` 和 `cigarette`，且持续一定时间
3. **防误报**: 需要连续10帧确认才推送数据

### 安全帽检测
1. **实时检测**: 检测是否戴安全帽
2. **异常推送**: 检测到未戴安全帽时推送数据
3. **防误报**: 需要连续10帧确认才推送数据

## 数据推送格式

### 吸烟检测数据包
```
(1, 1, 0, 5, state, 1, 0, 0, 0)
```
- `state = 1`: 检测到吸烟
- `state = 0`: 未检测到吸烟

### 安全帽检测数据包
```
(1, 1, 0, 2, state, 1, 0, 0, 0)
```
- `state = 1`: 未戴安全帽
- `state = 0`: 戴安全帽

## 注意事项

1. **模型文件**: 确保 `smoking.rknn` 和 `helmet.rknn` 文件存在
2. **摄像头**: 需要可用的RGB摄像头
3. **网络**: 确保UDP通信正常
4. **性能**: 建议在RKNN设备上运行

## 总结

现在您的系统具备了：
- ✅ 智能吸烟检测（三类别支持）
- ✅ 完善的安全帽检测
- ✅ 自动数据推送机制
- ✅ 防误报逻辑
- ✅ 独立的UDP处理

所有功能都已按照火焰和安全帽的逻辑进行了统一处理，确保系统的一致性和可靠性。 