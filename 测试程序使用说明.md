# 视觉检测任务测试程序使用说明

本项目包含6个独立的测试程序，分别用于测试不同的视觉检测任务。每个程序都是完整的、可独立运行的测试应用。

## 测试程序列表

### 1. 红外入侵检测测试 (`test_infrared.py`)
- **功能**: 测试红外摄像头的入侵检测功能
- **模型**: `yolov7_tiny-a.rknn`
- **摄像头**: 红外摄像头（使用`video_number.inf_numbers`配置）
- **检测结果**: 1=检测到入侵, 0=正常
- **报警阈值**: 连续10帧检测到入侵时发出警告

### 2. 火焰检测测试 (`test_flame.py`)
- **功能**: 测试RGB摄像头的火焰检测功能
- **模型**: `fire.rknn`
- **摄像头**: RGB摄像头（使用`video_number.rgb_numbers`配置）
- **检测结果**: 1=检测到火焰, 0=无火焰, None=不确定
- **报警阈值**: 连续10帧检测到火焰时发出警告

### 3. 人脸识别测试 (`test_face.py`)
- **功能**: 测试RGB摄像头的人脸识别功能
- **模型**: `retinaface_mob.rknn` + `mobilefacenet.rknn`
- **摄像头**: RGB摄像头（使用`video_number.rgb_numbers`配置）
- **检测结果**: 显示识别到的人脸姓名或"Unknown"
- **人脸数据**: 使用预训练的人脸编码数据库

### 4. 仪表读数测试 (`test_meter.py`)
- **功能**: 测试RGB摄像头的仪表检测和读数功能
- **模型**: `yolov8_meter.rknn`（假设的模型名称）
- **摄像头**: RGB摄像头（使用`video_number.rgb_numbers`配置）
- **检测结果**: 显示仪表的数值读数
- **特殊功能**: 包含指针和刻度的分割检测，自动计算读数

### 5. 安全帽检测测试 (`test_hardhat.py`)
- **功能**: 测试RGB摄像头的安全帽佩戴检测功能
- **模型**: `helmet.rknn`
- **摄像头**: RGB摄像头（使用`video_number.rgb_numbers`配置）
- **检测结果**: 1=未戴安全帽, 0=戴安全帽, None=不确定
- **报警阈值**: 连续10帧检测到未戴安全帽时发出警告

### 6. 吸烟检测测试 (`test_smoking.py`)
- **功能**: 测试RGB摄像头的吸烟行为检测功能
- **模型**: `smoking.rknn`
- **摄像头**: RGB摄像头（使用`video_number.rgb_numbers`配置）
- **检测结果**: 1=检测到吸烟, 0=无吸烟, None=不确定
- **报警阈值**: 连续20帧检测到吸烟时发出警告
- **特殊功能**: 检测香烟、人脸和吸烟动作的组合

## 运行方法

### 环境要求
确保已安装所有依赖包：
```bash
pip install -r requirements.txt
```

### 运行单个测试程序
```bash
# 红外入侵检测测试
python test_infrared.py

# 火焰检测测试
python test_flame.py

# 人脸识别测试
python test_face.py

# 仪表读数测试
python test_meter.py

# 安全帽检测测试
python test_hardhat.py

# 吸烟检测测试
python test_smoking.py
```

### 操作说明
- 运行程序后，会自动打开摄像头并开始检测
- 程序会在图像上实时显示检测结果和状态信息
- 按 **'q'** 键退出程序
- 程序会显示帧率信息和检测状态

## 文件结构

```
├── test_infrared.py      # 红外入侵检测测试程序
├── test_flame.py         # 火焰检测测试程序
├── test_face.py          # 人脸识别测试程序
├── test_meter.py         # 仪表读数测试程序
├── test_hardhat.py       # 安全帽检测测试程序
├── test_smoking.py       # 吸烟检测测试程序
├── main.py              # 原始主程序（多任务集成版本）
├── func_*.py            # 各功能模块
├── rknnpool_*.py        # RKNN模型池管理
├── video_number.py      # 摄像头配置
├── model_data/          # 模型和数据文件
├── *.rknn              # RKNN模型文件
└── requirements.txt     # 依赖包列表
```

## 注意事项

### 1. 摄像头配置
- 确保`video_number.py`文件中正确配置了摄像头编号
- 红外检测使用红外摄像头，其他任务使用RGB摄像头

### 2. 模型文件
- 确保所有`.rknn`模型文件存在于项目根目录
- 模型文件名必须与程序中指定的名称一致

### 3. 人脸识别数据
- 人脸识别需要预训练的编码数据文件：
  - `model_data/mobilenet_face_encoding.npy`
  - `model_data/mobilenet_names.npy`

### 4. 仪表检测特殊说明
- 仪表检测程序中的模型路径可能需要根据实际模型文件调整
- 需要确保`matplotlib`库已安装（用于仪表读数可视化）

### 5. 性能优化
- 每个程序使用3个线程池执行器（TPEs=3）
- 帧队列大小限制为5帧，避免内存溢出
- 程序会自动显示帧率信息

## 故障排除

### 1. 摄像头无法打开
- 检查摄像头是否被其他程序占用
- 确认`video_number.py`中的摄像头编号是否正确
- 尝试不同的摄像头编号

### 2. 模型加载失败
- 确认模型文件存在且路径正确
- 检查模型文件是否损坏
- 确认RKNN运行时环境已正确安装

### 3. 检测结果异常
- 检查摄像头画面质量
- 调整检测阈值参数
- 确认光照条件是否适合

### 4. 程序崩溃
- 检查所有依赖包是否正确安装
- 查看错误日志信息
- 确认系统资源是否充足

## 扩展说明

这些测试程序都是基于原始`main.py`的功能模块独立提取的，保持了相同的检测逻辑和参数设置。每个程序都可以独立运行，方便单独测试和调试特定功能。

如果需要修改检测参数或添加新功能，可以直接修改对应的测试程序文件。
