# 文件间数据流向详解

## 1. 系统启动阶段

### 摄像头识别
```
video_number.py → main.py
├── 扫描 /sys/class/video4linux/
├── 返回 inf_numbers[] (红外摄像头编号)
└── 返回 rgb_numbers[] (RGB摄像头编号)
```

### 系统初始化
```
main.py → TaskManager类
├── 创建 CameraManager 实例
├── 创建 frame_queues 字典
└── 创建 display_queue 队列
```

## 2. 摄像头管理

### 摄像头打开
```
main.py → CameraManager类 → video_number.py
├── get_infrared_camera() 调用
├── 使用 video_number.inf_numbers
└── open_camera() 返回摄像头句柄
```

### 图像采集
```
CameraManager类 → camera_capture函数 → frame_queues
├── cam.read() 读取图像帧
└── frame_queue.put(frame) 放入队列
```

## 3. 任务调度

### UDP命令接收
```
UDP网络 → UDPServer类 → udp_receive_commands函数 → TaskManager类
├── sock.recvfrom() 接收数据
├── struct.unpack() 解析数据帧
└── 调用 task_manager.start_tasks()/stop_tasks()
```

### 任务启动
```
TaskManager类 → task_worker函数 → 具体检测任务函数
├── start_tasks([task_code]) 调用
├── 创建线程执行 task_worker
└── 根据 task_code 调用对应任务
```

**任务映射：**
```
task_code=0 → face_recognition_task()
task_code=2 → hardhat_detection_task()
task_code=3 → infrared_detection_task()
task_code=4 → flame_detection_task()
task_code=5 → smoke_detection_task()
```

## 4. 模型推理

### 模型池初始化
```
检测任务函数 → rknnpool_*.py → RKNNLite
├── 调用 rknnPoolExecutor_* 构造函数
├── initRKNNs() 创建模型池
└── 加载 RKNN 模型文件
```

**模型文件映射：**
```
人脸识别: rknnpool_rgb.py → retinaface_mob.rknn + mobilefacenet.rknn
红外检测: rknnpool_inf.py → yolov7_tiny-a.rknn
火焰检测: rknnpool_flame.py → fire.rknn
安全帽检测: rknnpool_hardhat.py → helmet.rknn
吸烟检测: rknnpool_smoke.py → smoking.rknn
```

### 推理任务提交
```
检测任务函数 → rknnpool_*.py → func_*.py
├── pool.put(frame) 提交图像帧
├── ThreadPoolExecutor 分配线程
└── 调用对应的 myFunc_* 函数
```

**函数映射：**
```
人脸识别: myFunc_face(rknn_model1, rknn_model2, frame, num)
红外检测: myFunc_inf(rknn_model, frame, num)
火焰检测: myFunc_flame(rknn_model, frame, num)
安全帽检测: myFunc_hardhat(rknn_model, frame, num)
吸烟检测: myFunc_smoke(rknn_model, frame, num)
```

### 推理结果返回
```
func_*.py → rknnpool_*.py → 检测任务函数
├── 模型推理完成
├── 后处理得到结果
└── pool.get() 返回 (processed_frame, detection_result)
```

## 5. 检测算法数据流

### 人脸识别
```
func_face.py → model_data/ → 全局变量
├── 加载 mobilenet_face_encoding.npy
├── 加载 mobilenet_names.npy
├── RetinaFace 人脸检测
├── MobileFaceNet 特征提取
└── 更新 func_face.name_ten 列表
```

### 红外入侵检测
```
func_v7.py → main.py → UDP通信
├── YOLOv7 人体检测
├── 更新 class_inf 全局变量
└── 触发异常数据推送
```

### 火焰检测
```
func_flame.py → main.py → UDP通信
├── YOLOv8 火焰检测
├── FlameDetector 滑动窗口确认
├── 更新 class_flame 全局变量
└── 触发异常数据推送
```

### 安全帽检测
```
func_hardhat.py → main.py → UDP通信
├── YOLOv8 安全帽检测
├── HardhatDetector 滑动窗口确认
├── 更新 class_hardhat 全局变量
└── 触发异常数据推送
```

### 吸烟检测
```
func_smoke.py → main.py → UDP通信
├── YOLOv8 多类别检测
├── SmokeDetector 行为分析
├── 更新 class_smoke 全局变量
└── 触发异常数据推送
```

## 6. 状态管理

### 任务状态更新
```
检测任务函数 → main.py 全局变量 → UDP响应
├── 任务启动: state_xxx = True
├── 任务结束: state_xxx = False
└── UDP请求检查状态并返回数据
```

**状态变量：**
```
state_env: 人脸识别任务状态
state_inf: 红外入侵检测任务状态
state_flame: 火焰检测任务状态
state_smoke: 吸烟检测任务状态
state_hardhat: 安全帽检测任务状态
```

### UDP状态查询
```
UDP网络 → UDPServer类 → udp_receive_commands函数 → 状态检查 → UDP响应
├── 接收数据请求帧
├── 检查对应 state_xxx 变量
└── 发送UDP响应帧
```

## 7. 异常检测

### 异常检测流程
```
检测任务函数 → 异常计数 → 阈值判断 → send_abnormal_data函数 → UDP网络
├── 连续异常帧计数 (abnormal_count)
├── 阈值判断 (10-20帧)
└── UDP数据帧发送
```

**异常阈值：**
```
红外入侵: 10帧连续检测到人体
火焰检测: 10帧连续检测到火焰
安全帽检测: 10帧连续检测到未戴安全帽
吸烟检测: 20帧连续检测到吸烟行为
```

## 8. 显示数据流

### 显示队列
```
检测任务函数 → display_queue → show_frames函数 → OpenCV显示
├── display_queue.put((processed_frame, task_code))
├── show_frames() 获取显示数据
└── cv2.imshow() 显示图像
```

**任务代号：**
```
task_code=0: 人脸识别显示
task_code=1: 红外入侵检测显示
task_code=2: 安全帽检测显示
task_code=4: 火焰检测显示
task_code=5: 吸烟检测显示
```

## 9. 资源管理

### 资源释放
```
检测任务函数 → rknnpool_*.py → RKNNLite → 系统资源
├── pool.release() 调用
├── pool.shutdown() 关闭线程池
└── rknn_lite.release() 释放模型
```

### 摄像头释放
```
TaskManager类 → CameraManager类 → OpenCV → 系统资源
├── release_cameras() 调用
└── cam.release() 释放摄像头
```

## 10. 完整数据流向图

### 启动阶段
```
video_number.py → main.py → TaskManager类 → UDPServer类
```

### 运行阶段
```
UDP网络 → UDPServer类 → main.py → TaskManager类 → 检测任务函数 → rknnpool_*.py → func_*.py → 全局变量 → UDP响应
```

### 显示阶段
```
检测任务函数 → display_queue → show_frames函数 → OpenCV显示
```

### 异常推送阶段
```
检测任务函数 → 异常判断 → send_abnormal_data函数 → UDPServer类 → UDP网络
```

## 11. 关键数据传递点

### 图像数据传递
```
摄像头硬件 → video_number.py → CameraManager类 → frame_queues → 检测任务函数 → rknnpool_*.py → func_*.py
```

### 检测结果传递
```
func_*.py → 检测任务函数 → 全局变量 → UDP响应/异常推送
```

### 控制命令传递
```
UDP网络 → UDPServer类 → main.py → TaskManager类 → 检测任务函数
```

### 状态信息传递
```
检测任务函数 → 全局变量 → UDP响应 → 服务器
```

## 12. 总结

系统数据流向特点：

1. **模块化设计**: 每个文件负责特定功能，通过明确接口交换数据
2. **队列缓冲**: 使用队列机制缓冲图像数据，避免阻塞
3. **全局状态**: 使用全局变量管理任务状态和检测结果
4. **异步通信**: UDP通信采用异步方式，不阻塞主处理流程
5. **资源管理**: 统一的资源分配和释放机制

通过这种设计，系统实现了高效、可靠的数据传递和处理。
