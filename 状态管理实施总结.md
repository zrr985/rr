# 检测任务状态管理实施总结

## 1. 已完成的修改

### 1.1 全局状态变量添加
在 `main.py` 和 `maincopy.py` 中添加了以下状态变量：

```python
# 任务状态管理变量
state_env = False        # 人脸识别任务状态（已有）
state_inf = False        # 红外入侵检测任务状态（新增）
state_flame = False      # 火焰检测任务状态（新增）
state_smoke = False      # 吸烟检测任务状态（新增）
state_hardhat = False    # 安全帽检测任务状态（新增）
```

### 1.2 任务函数状态管理

#### 1.2.1 红外入侵检测任务
```python
def infrared_detection_task(frame_queue, display_queue, stop_event):
    global class_inf, state_inf
    state_inf = True  # 设置任务运行状态
    
    # ... 任务代码 ...
    
    state_inf = False  # 重置任务状态
    pool.release()
```

#### 1.2.2 安全帽检测任务
```python
def hardhat_detection_task(frame_queue, display_queue, stop_event):
    global classes_data, class_hardhat, state_hardhat
    state_hardhat = True  # 设置任务运行状态
    
    # ... 任务代码 ...
    
    state_hardhat = False  # 重置任务状态
    pool.release()
```

#### 1.2.3 吸烟检测任务
```python
def smoke_detection_task(frame_queue, display_queue, stop_event):
    global classes_data, class_smoke, state_smoke
    state_smoke = True  # 设置任务运行状态
    
    # ... 任务代码 ...
    
    state_smoke = False  # 重置任务状态
    pool.release()
```

#### 1.2.4 火焰检测任务
```python
def flame_detection_task(frame_queue, display_queue, stop_event):
    global class_flame, state_flame
    state_flame = True  # 设置任务运行状态
    
    # ... 任务代码 ...
    
    state_flame = False  # 重置任务状态
    pool.release()
```

### 1.3 UDP通信状态检查

#### 1.3.1 红外入侵检测数据请求
```python
if frame_data[3] == 3:  #需要红外入侵数据
    if state_inf is True:  # 检查任务状态
        if class_inf == 1:
            state_inf = 1
        else:
            state_inf = 0
        state_inf = int(state_inf)
        data_inf = (1, 1, 0, 3, state_inf, 0, 0, 0, 0)
    else:  # 任务未运行
        data_inf = (1, 1, 0, 3, 0, 0, 0, 0, 0)
    pack_data_inf = struct.pack(frame_format_meter, *data_inf)
    udp_server.send_response(client_addr, pack_data_inf)
```

#### 1.3.2 安全帽检测数据请求
```python
if frame_data[3] == 2:  #需要安全帽检测数据
    if state_hardhat is True:  # 检查任务状态
        data_hardhat = (1, 1, 0, 2, class_hardhat, 1, 0, 0, 0)
        print(f"发送安全帽检测数据：{'未戴安全帽' if class_hardhat == 1 else '戴安全帽'}")
    else:  # 任务未运行
        data_hardhat = (1, 1, 0, 2, 0, 0, 0, 0, 0)
        print("发送安全帽检测数据：任务未运行")
```

#### 1.3.3 吸烟检测数据请求
```python
if frame_data[3] == 5:  #需要吸烟检测数据
    if state_smoke is True:  # 检查任务状态
        data_smoke = (1, 1, 0, 5, class_smoke, 1, 0, 0, 0)
        print(f"发送吸烟检测数据：{'检测到吸烟' if class_smoke == 1 else '无吸烟'}")
    else:  # 任务未运行
        data_smoke = (1, 1, 0, 5, 0, 0, 0, 0, 0)
        print("发送吸烟检测数据：任务未运行")
```

#### 1.3.4 火焰检测数据请求
```python
if frame_data[3] == 4:  #需要火焰检测数据
    if state_flame is True:  # 检查任务状态
        data_flame = (1, 1, 0, 4, 1, 1, 0, 0, 0)
        print("发送火焰检测数据：任务运行中")
    else:  # 任务未运行
        data_flame = (1, 1, 0, 4, 0, 0, 0, 0, 0)
        print("发送火焰检测数据：任务未运行")
```

