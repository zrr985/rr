# 文件间数据流向详解

## 概述
本文档详细分析了视觉检测系统中各个文件之间的数据流向，明确标注每个数据流是从哪个文件流向哪个文件，便于理解整个系统的数据传递过程。

## 1. 系统启动阶段数据流

### 1.1 摄像头识别阶段
```
video_number.py → main.py
├── 扫描 /sys/class/video4linux/
├── 读取 modalias 识别硬件ID
├── 返回 inf_numbers[] (红外摄像头编号列表)
└── 返回 rgb_numbers[] (RGB摄像头编号列表)
```

**数据内容：**
- `inf_numbers`: 红外摄像头设备编号列表
- `rgb_numbers`: RGB摄像头设备编号列表

### 1.2 系统初始化阶段
```
main.py → TaskManager类
├── 创建 CameraManager 实例
├── 创建 frame_queues 字典
├── 创建 display_queue 队列
└── 初始化线程管理字典
```

**数据内容：**
- `frame_queues['infrared']`: 红外图像队列 (maxsize=5)
- `frame_queues['rgb']`: RGB图像队列 (maxsize=5)
- `display_queue`: 显示队列 (maxsize=10)

## 2. 摄像头管理数据流

### 2.1 摄像头打开流程
```
main.py → CameraManager类 → video_number.py
├── get_infrared_camera() 调用
├── 使用 video_number.inf_numbers
├── open_camera() 尝试打开设备
└── 返回摄像头句柄
```

### 2.2 图像采集数据流
```
CameraManager类 → camera_capture函数 → frame_queues
├── cam.read() 读取图像帧
├── frame_queue.put(frame) 放入队列
└── 循环采集直到 stop_event 触发
```

**数据流向：**
```
摄像头硬件 → OpenCV → camera_capture函数 → frame_queues['infrared'/'rgb']
```

## 3. 任务调度数据流

### 3.1 UDP命令接收流程
```
UDP网络 → UDPServer类 → udp_receive_commands函数 → TaskManager类
├── sock.recvfrom() 接收UDP数据
├── struct.unpack() 解析数据帧
├── 解析控制命令
└── 调用 task_manager.start_tasks()/stop_tasks()
```

**数据内容：**
- UDP数据帧: `(2, 0, 0, task_code, 0, action, 0, 0, 0)`
- `task_code`: 任务代号 (0=人脸, 2=安全帽, 3=红外, 4=火焰, 5=吸烟)
- `action`: 动作 (1=启动, 2=停止, 0=关闭所有)

### 3.2 任务启动流程
```
TaskManager类 → task_worker函数 → 具体检测任务函数
├── start_tasks([task_code]) 调用
├── 创建线程执行 task_worker
├── task_worker 根据 task_code 调用对应任务
└── 启动具体检测任务函数
```

**任务映射关系：**
```
task_code=0 → face_recognition_task()
task_code=2 → hardhat_detection_task()
task_code=3 → infrared_detection_task()
task_code=4 → flame_detection_task()
task_code=5 → smoke_detection_task()
```

## 4. 模型推理数据流

### 4.1 模型池初始化流程
```
具体检测任务函数 → rknnpool_*.py → RKNNLite
├── 调用 rknnPoolExecutor_* 构造函数
├── initRKNNs() 创建模型池
├── 加载 RKNN 模型文件
└── 初始化 NPU 核心
```

**模型文件映射：**
```
人脸识别: rknnpool_rgb.py → retinaface_mob.rknn + mobilefacenet.rknn
红外检测: rknnpool_inf.py → yolov7_tiny-a.rknn
火焰检测: rknnpool_flame.py → fire.rknn
安全帽检测: rknnpool_hardhat.py → helmet.rknn
吸烟检测: rknnpool_smoke.py → smoking.rknn
仪表检测: rknnpool_meter.py → yolov8_seg.rknn
```

### 4.2 推理任务提交流程
```
检测任务函数 → rknnpool_*.py → func_*.py
├── pool.put(frame) 提交图像帧
├── ThreadPoolExecutor 分配线程
├── 调用对应的 myFunc_* 函数
└── 执行模型推理
```

**函数映射关系：**
```
人脸识别: myFunc_face(rknn_model1, rknn_model2, frame, num)
红外检测: myFunc_inf(rknn_model, frame, num)
火焰检测: myFunc_flame(rknn_model, frame, num)
安全帽检测: myFunc_hardhat(rknn_model, frame, num)
吸烟检测: myFunc_smoke(rknn_model, frame, num)
仪表检测: myFunc_meter(rknn_model, frame)
```

### 4.3 推理结果返回流程
```
func_*.py → rknnpool_*.py → 检测任务函数
├── 模型推理完成
├── 后处理得到结果
├── pool.get() 获取结果
└── 返回 (processed_frame, detection_result)
```

## 5. 检测算法数据流

### 5.1 人脸识别数据流
```
func_face.py → model_data/ → 全局变量
├── 加载 mobilenet_face_encoding.npy
├── 加载 mobilenet_names.npy
├── RetinaFace 人脸检测
├── MobileFaceNet 特征提取
├── 特征匹配识别
└── 更新 func_face.name_ten 列表
```

**数据流向：**
```
RGB图像 → func_face.py → 人脸检测结果 → main.py (state_env=True时)
```

### 5.2 红外入侵检测数据流
```
func_v7.py → main.py → UDP通信
├── YOLOv7 人体检测
├── 更新 class_inf 全局变量
├── 连续异常帧计数
└── 触发异常数据推送
```

**数据流向：**
```
红外图像 → func_v7.py → class_inf → main.py → send_abnormal_data()
```

### 5.3 火焰检测数据流
```
func_flame.py → main.py → UDP通信
├── YOLOv8 火焰检测
├── FlameDetector 滑动窗口确认
├── 更新 class_flame 全局变量
└── 触发异常数据推送
```

**数据流向：**
```
RGB图像 → func_flame.py → class_flame → main.py → send_abnormal_data()
```

### 5.4 安全帽检测数据流
```
func_hardhat.py → main.py → UDP通信
├── YOLOv8 安全帽检测
├── HardhatDetector 滑动窗口确认
├── 更新 class_hardhat 全局变量
└── 触发异常数据推送
```

**数据流向：**
```
RGB图像 → func_hardhat.py → class_hardhat → main.py → send_abnormal_data()
```

### 5.5 吸烟检测数据流
```
func_smoke.py → main.py → UDP通信
├── YOLOv8 多类别检测
├── SmokeDetector 行为分析
├── 更新 class_smoke 全局变量
└── 触发异常数据推送
```

**数据流向：**
```
RGB图像 → func_smoke.py → class_smoke → main.py → send_abnormal_data()
```

## 6. 状态管理数据流

### 6.1 任务状态更新流程
```
检测任务函数 → main.py 全局变量 → UDP响应
├── 任务启动: state_xxx = True
├── 任务结束: state_xxx = False
├── UDP请求检查状态
└── 根据状态返回数据
```

**状态变量映射：**
```
state_env: 人脸识别任务状态
state_inf: 红外入侵检测任务状态
state_flame: 火焰检测任务状态
state_smoke: 吸烟检测任务状态
state_hardhat: 安全帽检测任务状态
```

### 6.2 UDP状态查询流程
```
UDP网络 → UDPServer类 → udp_receive_commands函数 → 状态检查 → UDP响应
├── 接收数据请求帧
├── 检查对应 state_xxx 变量
├── 准备响应数据
└── 发送UDP响应帧
```

## 7. 异常检测数据流

### 7.1 异常检测流程
```
检测任务函数 → 异常计数 → 阈值判断 → send_abnormal_data函数 → UDP网络
├── 连续异常帧计数 (abnormal_count)
├── 阈值判断 (10-20帧)
├── 防止重复推送 (abnormal_pushed)
└── UDP数据帧发送
```

**异常阈值设置：**
```
红外入侵: 10帧连续检测到人体
火焰检测: 10帧连续检测到火焰
安全帽检测: 10帧连续检测到未戴安全帽
吸烟检测: 20帧连续检测到吸烟行为
```

### 7.2 异常数据推送流程
```
send_abnormal_data函数 → UDPServer类 → UDP网络
├── 构造异常数据帧
├── struct.pack() 打包数据
├── udp_server.send_response() 发送
└── 服务器接收异常数据
```

## 8. 显示数据流

### 8.1 显示队列数据流
```
检测任务函数 → display_queue → show_frames函数 → OpenCV显示
├── display_queue.put((processed_frame, task_code))
├── show_frames() 获取显示数据
├── cv2.imshow() 显示图像
└── cv2.waitKey() 处理按键
```

**任务代号映射：**
```
task_code=0: 人脸识别显示
task_code=1: 红外入侵检测显示
task_code=2: 安全帽检测显示
task_code=4: 火焰检测显示
task_code=5: 吸烟检测显示
```

## 9. 资源管理数据流

### 9.1 资源释放流程
```
检测任务函数 → rknnpool_*.py → RKNNLite → 系统资源
├── pool.release() 调用
├── pool.shutdown() 关闭线程池
├── rknn_lite.release() 释放模型
└── 释放NPU核心和内存
```

### 9.2 摄像头释放流程
```
TaskManager类 → CameraManager类 → OpenCV → 系统资源
├── release_cameras() 调用
├── cam.release() 释放摄像头
└── 释放摄像头硬件资源
```

## 10. 完整数据流向图

### 10.1 启动阶段
```
video_number.py → main.py → TaskManager类 → UDPServer类
```

### 10.2 运行阶段
```
UDP网络 → UDPServer类 → main.py → TaskManager类 → 检测任务函数 → rknnpool_*.py → func_*.py → 全局变量 → UDP响应
```

### 10.3 显示阶段
```
检测任务函数 → display_queue → show_frames函数 → OpenCV显示
```

### 10.4 异常推送阶段
```
检测任务函数 → 异常判断 → send_abnormal_data函数 → UDPServer类 → UDP网络
```

## 11. 关键数据传递点

### 11.1 图像数据传递
```
摄像头硬件 → video_number.py → CameraManager类 → frame_queues → 检测任务函数 → rknnpool_*.py → func_*.py
```

### 11.2 检测结果传递
```
func_*.py → 检测任务函数 → 全局变量 → UDP响应/异常推送
```

### 11.3 控制命令传递
```
UDP网络 → UDPServer类 → main.py → TaskManager类 → 检测任务函数
```

### 11.4 状态信息传递
```
检测任务函数 → 全局变量 → UDP响应 → 服务器
```

## 12. 总结

整个系统的数据流向遵循以下原则：

1. **模块化设计**: 每个文件负责特定功能，通过明确的接口进行数据交换
2. **队列缓冲**: 使用队列机制缓冲图像数据，避免阻塞
3. **全局状态**: 使用全局变量管理任务状态和检测结果
4. **异步通信**: UDP通信采用异步方式，不阻塞主处理流程
5. **资源管理**: 统一的资源分配和释放机制

通过这种设计，系统实现了高效、可靠的数据传递和处理，确保了各个模块之间的协调工作。
