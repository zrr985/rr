# 多线程检测系统使用说明

## 🎯 系统架构

新的多线程检测系统解决了摄像头冲突问题，采用以下架构：

```
单个进程
├── 主线程 (协调管理)
├── 摄像头线程 (1个，负责采集帧)
├── 安全帽检测任务
│   ├── 推理线程1 (NPU核心0)
│   ├── 推理线程2 (NPU核心1)
│   └── 推理线程3 (NPU核心2)
├── 火焰检测任务
│   ├── 推理线程1 (NPU核心0)
│   ├── 推理线程2 (NPU核心1)
│   └── 推理线程3 (NPU核心2)
└── 吸烟检测任务
    ├── 推理线程1 (NPU核心0)
    ├── 推理线程2 (NPU核心1)
    └── 推理线程3 (NPU核心2)
```

## 🚀 优势

1. **真正的资源共享**：所有线程共享同一个摄像头实例
2. **避免系统冲突**：操作系统只看到一个进程在使用摄像头
3. **灵活的任务管理**：可以动态启动/停止检测任务
4. **独立的显示窗口**：每个检测任务有自己的显示窗口
5. **更好的性能**：减少进程间通信开销

## 📁 文件结构

```
cpp/
├── include/
│   └── multi_thread_detection_system.h    # 多线程检测系统头文件
├── src/
│   └── multi_task_detection.cc             # 重写的多线程主程序
└── test_multi_thread_detection.sh          # 测试脚本
```

## 🔧 编译方法

```bash
cd cpp/build
make multi_task_detection
```

## 💻 使用方法

### 1. 多任务检测（推荐）

同时运行多个检测任务，共享摄像头：

```bash
# 安全帽 + 火焰 + 吸烟检测
./multi_task_detection --helmet ../model/helmet.rknn --flame ../model/fire.rknn --smoking ../model/smoking.rknn

# 只运行安全帽检测
./multi_task_detection --helmet ../model/helmet.rknn

# 只运行火焰检测
./multi_task_detection --flame ../model/fire.rknn

# 只运行吸烟检测
./multi_task_detection --smoking ../model/smoking.rknn
```

### 2. 指定摄像头

```bash
# 使用摄像头1
./multi_task_detection --helmet ../model/helmet.rknn --camera 1
```

### 3. 支持的任务类型

- `--helmet` : 安全帽检测
- `--flame` : 火焰检测  
- `--smoking` : 吸烟检测
- `--face` : 人脸检测（需要模型）
- `--meter` : 仪表检测（需要模型）

## 🎮 操作说明

1. **启动程序**：运行上述命令
2. **查看结果**：每个检测任务会打开独立窗口
3. **退出程序**：在任何窗口按 'q' 键
4. **统计信息**：程序会每10秒打印一次检测统计

## 🔍 显示效果

每个检测窗口会显示：
- **检测框**：不同颜色区分不同检测类型
  - 绿色：安全帽
  - 红色：无安全帽
  - 橙色：火焰
  - 蓝色：吸烟
- **统计信息**：
  - FPS：帧率
  - Detections：检测次数
  - Task：任务名称
  - Time：处理时间

## 🆚 与Python对比

### Python方式（有冲突）：
```bash
# 不同终端运行，但实际上是不同进程
python helmet_detection.py  # 进程A
python flame_detection.py    # 进程B - 冲突！
```

### 新的C++方式（无冲突）：
```bash
# 单个进程，多个线程
./multi_task_detection --helmet ../model/helmet.rknn --flame ../model/fire.rknn
# 一个进程，多个线程共享摄像头 - 无冲突！
```

## 🐛 故障排除

### 1. 编译错误
```bash
# 确保所有依赖已安装
sudo apt-get install libopencv-dev
sudo apt-get install librknn-dev
```

### 2. 摄像头冲突
- 确保只运行一个多线程检测程序
- 检查是否有其他程序占用摄像头

### 3. 模型文件不存在
- 确保模型文件路径正确
- 检查模型文件权限

## 📊 性能监控

程序会显示：
- 实时FPS统计
- 检测次数统计
- 处理时间统计
- 线程状态信息

## 🎯 最佳实践

1. **推荐使用多任务模式**：一次运行多个检测任务
2. **避免同时运行多个程序**：防止摄像头冲突
3. **监控系统资源**：注意CPU和内存使用
4. **定期检查检测效果**：确保检测准确性

## 🔄 升级说明

从旧版本升级：
1. 备份现有代码
2. 使用新的多线程检测系统
3. 测试所有检测功能
4. 更新启动脚本

## 📞 技术支持

如遇问题，请检查：
1. 编译是否成功
2. 模型文件是否存在
3. 摄像头是否可用
4. 系统资源是否充足
