# 仪表检测控制命令逻辑详解

## 1. 代码段分析

```python
# 处理仪表检测相关命令
if frame_data[1] == 3 and frame_data[0] == 2:  # 仪表检测控制命令
    print("仪表检测")
    if frame_data[5] == 1:  # 启动仪表检测
        print("恢复处理服务器的帧")
        task_manager.reset()  # 重置任务管理器
        task_manager.start_tasks([0])  # 启动人脸识别任务
    elif frame_data[5] == 0:  # 停止仪表检测
        print("忽略其他帧")
        task_manager.stop_all_tasks()  # 停止所有任务
        # 发送完成响应
        data = (2, 1, 3, 1, 3, 0, 0, 0, 0)
        pack_data = struct.pack(frame_format_meter, *data)
        udp_server.send_response(client_addr, pack_data)
    continue
```

## 2. UDP数据帧格式解析

### 2.1 数据帧结构
根据 `frame_format_meter = 'IIIIIIIff'`，UDP数据帧包含9个字段：

```python
# 数据帧字段定义
frame_data = (
    frame_data[0],  # 第1位：请求类型
    frame_data[1],  # 第2位：设备类型
    frame_data[2],  # 第3位：设备类型
    frame_data[3],  # 第4位：子任务类型
    frame_data[4],  # 第5位：存在状态
    frame_data[5],  # 第6位：控制命令/数据类型
    frame_data[6],  # 第7位：保留字段
    frame_data[7],  # 第8位：温度读数/保留字段
    frame_data[8]   # 第9位：保留字段
)
```

### 2.2 字段含义详解

#### **第1位：请求类型 (frame_data[0])**
```python
REQUEST_DATA = 0    # 请求数据
GIVE_DATA = 1       # 提供数据
CONTROL_COMMOND = 2 # 控制命令
```

#### **第2位：设备类型 (frame_data[1])**
```python
SERVER = 0  # 服务器
VISION = 1  # 视觉系统
ROBOT = 2   # 机器人
METER = 3   # 仪表检测系统
```

#### **第3位：设备类型 (frame_data[2])**
- 通常与第2位配合使用，表示具体的设备子类型

#### **第4位：子任务类型 (frame_data[3])**
```python
SUB_FACE = 0      # 人脸识别
SUB_METER = 1     # 仪表检测
SUB_HARDHAT = 2   # 安全帽检测
SUB_INF = 3       # 红外入侵检测
SUB_THR = 4       # 温度检测
SUB_GAS = 5       # 气体检测
SUB_SMOKE = 6     # 吸烟检测
```

#### **第5位：存在状态 (frame_data[4])**
```python
EXIST = 1      # 存在
NOT_EXIST = 0  # 不存在
FINSH = 3      # 完成（无关）
```

#### **第6位：控制命令/数据类型 (frame_data[5])**
```python
# 仪表检测控制帧
CLOSE_ALL = 0  # 关闭所有
START = 1      # 启动
CLOSE = 2      # 关闭

# 仪表检测数据类型
METER_TYPE_XIAOFANG = 0  # 消防仪表
METER_TYPE_AIR = 1       # 空气仪表
METER_TYPE_JIXIE = 2     # 机械仪表

# 安全帽/吸烟检测
HAT = 1        # 戴安全帽
NO_HAT = 0     # 未戴安全帽
SMOKE = 3      # 吸烟
NOT_SMOKE = 2  # 未吸烟
```

## 3. 仪表检测控制命令逻辑

### 3.1 命令识别条件
```python
if frame_data[1] == 3 and frame_data[0] == 2:
```
- `frame_data[1] == 3`：设备类型为仪表检测系统 (METER = 3)
- `frame_data[0] == 2`：请求类型为控制命令 (CONTROL_COMMOND = 2)

### 3.2 启动仪表检测
```python
if frame_data[5] == 1:  # START = 1
    print("恢复处理服务器的帧")
    task_manager.reset()  # 重置任务管理器
    task_manager.start_tasks([0])  # 启动人脸识别任务
```

**逻辑说明**：
- 当收到启动命令时，系统会：
  1. 重置任务管理器，清理所有正在运行的任务
  2. 启动人脸识别任务（任务代号0）
  3. 这可能是仪表检测系统需要人脸识别功能来验证操作人员身份

### 3.3 停止仪表检测
```python
elif frame_data[5] == 0:  # CLOSE_ALL = 0
    print("忽略其他帧")
    task_manager.stop_all_tasks()  # 停止所有任务
    # 发送完成响应
    data = (2, 1, 3, 1, 3, 0, 0, 0, 0)
    pack_data = struct.pack(frame_format_meter, *data)
    udp_server.send_response(client_addr, pack_data)
```

**逻辑说明**：
- 当收到停止命令时，系统会：
  1. 停止所有正在运行的检测任务
  2. 发送响应数据给客户端，确认操作完成

## 4. 响应数据详解

### 4.1 响应数据字段
```python
data = (2, 1, 3, 1, 3, 0, 0, 0, 0)
```

### 4.2 字段含义
```python
data[0] = 2  # 请求类型：GIVE_DATA (提供数据)
data[1] = 1  # 设备类型：VISION (视觉系统)
data[2] = 3  # 设备类型：METER (仪表检测系统)
data[3] = 1  # 子任务类型：SUB_METER (仪表检测)
data[4] = 3  # 存在状态：FINSH (完成)
data[5] = 0  # 控制命令：CLOSE_ALL (关闭所有)
data[6] = 0  # 保留字段
data[7] = 0  # 保留字段
data[8] = 0  # 保留字段
```

### 4.3 响应含义
这个响应数据表示：
- **视觉系统向仪表检测系统发送数据**
- **仪表检测任务已完成**
- **所有任务已关闭**

## 5. 完整工作流程

### 5.1 仪表检测启动流程
```
1. 外部系统发送启动命令
   UDP数据帧: (2, 3, ?, ?, ?, 1, 0, 0, 0)
   - 控制命令 (2)
   - 仪表检测系统 (3)
   - 启动命令 (1)

2. 视觉系统处理命令
   - 重置任务管理器
   - 启动人脸识别任务
   - 准备进行仪表检测

3. 仪表检测进行中
   - 人脸识别验证操作人员身份
   - 可能进行仪表读数检测
   - 实时监控和数据处理
```

### 5.2 仪表检测停止流程
```
1. 外部系统发送停止命令
   UDP数据帧: (2, 3, ?, ?, ?, 0, 0, 0, 0)
   - 控制命令 (2)
   - 仪表检测系统 (3)
   - 停止命令 (0)

2. 视觉系统处理命令
   - 停止所有检测任务
   - 释放摄像头资源
   - 清理线程和队列

3. 发送完成响应
   UDP响应帧: (2, 1, 3, 1, 3, 0, 0, 0, 0)
   - 确认任务已完成
   - 通知外部系统可以继续
```


