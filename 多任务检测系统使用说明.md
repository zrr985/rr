# 多任务视觉检测系统使用说明

## 系统概述

本系统提供了一个完整的多任务视觉检测解决方案，能够同时运行6种不同的检测任务：
- 🔴 红外入侵检测
- 🔥 火焰检测
- 👤 人脸识别
- 📊 仪表读数
- 🦺 安全帽检测
- 🚭 吸烟检测

## 文件结构

```
├── multi_task_detection.py      # 核心多任务检测系统
├── simple_multi_task.py         # 简化版控制界面
├── detection_config.py          # 配置文件
├── test_*_commented.py          # 单任务测试程序（6个）
├── 多任务检测系统使用说明.md    # 本文档
└── 功能验证报告.md              # 功能验证报告
```

## 快速开始

### 方法1：启动所有任务
```bash
python multi_task_detection.py
```
这将同时启动所有6个检测任务，每个任务都有独立的显示窗口。

### 方法2：交互式控制
```bash
python simple_multi_task.py
```
这将启动交互式控制界面，可以选择性地启动/停止特定任务。

### 方法3：单任务测试
```bash
python test_infrared_commented.py    # 只运行红外检测
python test_flame_commented.py       # 只运行火焰检测
python test_face_commented.py        # 只运行人脸识别
python test_meter_commented.py       # 只运行仪表检测
python test_hardhat_commented.py     # 只运行安全帽检测
python test_smoking_commented.py     # 只运行吸烟检测
```

## 详细使用指南

### 1. 多任务检测系统 (multi_task_detection.py)

**特点:**
- 同时运行所有6个检测任务
- 智能摄像头资源管理（红外和RGB摄像头共享）
- 独立的显示窗口和检测线程
- 自动异常检测和报警
- 实时状态监控

**运行方式:**
```bash
python multi_task_detection.py
```

**控制方式:**
- 在任意检测窗口按 `q` 键退出所有任务
- 按 `Ctrl+C` 强制退出程序
- 系统会每30秒自动打印状态信息

**输出示例:**
```
🌟 多任务视觉检测系统启动
============================================================
✅ 成功启动 6/6 个任务
📊 infrared: 15.2 FPS, 结果: 0
📊 flame: 14.8 FPS, 结果: 0
📊 face: 12.3 FPS, 结果: ['张三']
📊 meter: 11.7 FPS, 结果: 0.756
📊 hardhat: 13.9 FPS, 结果: 0
📊 smoking: 14.2 FPS, 结果: 0
```

### 2. 简化控制界面 (simple_multi_task.py)

**特点:**
- 交互式命令行界面
- 可选择性启动/停止任务
- 实时状态查询
- 用户友好的操作提示

**运行方式:**
```bash
python simple_multi_task.py
```

**可用命令:**
```
start <task>     - 启动指定任务
stop <task>      - 停止指定任务
start all        - 启动所有任务
stop all         - 停止所有任务
status           - 显示系统状态
help             - 显示帮助
quit             - 退出程序
```

**任务名称:**
- `infrared` 或 `1` - 红外入侵检测
- `flame` 或 `2` - 火焰检测
- `face` 或 `3` - 人脸识别
- `meter` 或 `4` - 仪表读数
- `hardhat` 或 `5` - 安全帽检测
- `smoking` 或 `6` - 吸烟检测

**使用示例:**
```
💬 请输入命令: start flame
🚀 启动任务: flame

💬 请输入命令: status
📊 多任务检测系统状态
🏃 运行中的任务: 1
   • flame: 0

💬 请输入命令: start all
🚀 启动所有任务...

💬 请输入命令: quit
👋 正在退出...
```

### 3. 配置系统 (detection_config.py)

**配置项说明:**

#### 全局配置
```python
THREAD_POOL_SIZE = 3              # RKNN模型线程池大小
FRAME_QUEUE_SIZE = 5              # 帧队列大小
DISPLAY_QUEUE_SIZE = 10           # 显示队列大小
```

#### 任务特定配置
每个任务都有独立的配置，例如：
```python
INFRARED_CONFIG = {
    'model_path': './yolov7_tiny-a.rknn',
    'abnormal_threshold': 10,      # 连续异常帧阈值
    'confidence_threshold': 0.5,   # 检测置信度阈值
    'window_title': '红外入侵检测',
    'enable_debug': True,          # 调试输出开关
    'alert_enabled': True,         # 报警开关
}
```

#### 自定义配置
可以通过环境变量控制运行模式：
```bash
# 测试模式（降低检测阈值）
export DETECTION_MODE=test
python multi_task_detection.py

# 演示模式（启用调试信息）
export DETECTION_MODE=demo
python multi_task_detection.py
```

**配置验证:**
```bash
python detection_config.py
```
这将验证配置的有效性并显示配置摘要。

## 系统架构

### 多线程架构
```
摄像头采集线程
    ↓
帧队列 (Queue)
    ↓
检测任务线程 (6个并行)
    ↓
显示队列 (Queue)
    ↓
显示线程 (6个并行)
```

### 摄像头资源管理
- **红外摄像头**: 仅供红外入侵检测使用
- **RGB摄像头**: 供其他5个任务共享使用
- 智能锁机制防止摄像头资源冲突

### 检测结果管理
- 每个任务有独立的结果存储
- 异常帧计数器自动重置
- 支持实时状态查询

## 检测任务详解

### 1. 红外入侵检测 (infrared)
- **功能**: 检测红外摄像头中的入侵行为
- **模型**: yolov7_tiny-a.rknn
- **阈值**: 连续10帧检测到入侵时报警
- **结果**: 0=正常, 1=检测到入侵

### 2. 火焰检测 (flame)
- **功能**: 检测RGB摄像头中的火焰
- **模型**: fire.rknn
- **阈值**: 连续10帧检测到火焰时报警
- **结果**: 0=无火焰, 1=检测到火焰

### 3. 人脸识别 (face)
- **功能**: 识别预训练数据库中的人脸
- **模型**: retinaface_mob.rknn + mobilefacenet.rknn
- **特点**: 双模型架构（检测+识别）
- **结果**: 返回识别到的人员姓名列表

### 4. 仪表读数 (meter)
- **功能**: 自动读取仪表指针数值
- **模型**: yolov8_meter.rknn
- **特点**: 包含指针分割和数值计算
- **结果**: 返回仪表读数（浮点数）

### 5. 安全帽检测 (hardhat)
- **功能**: 检测人员是否佩戴安全帽
- **模型**: helmet.rknn
- **阈值**: 连续10帧检测到未戴安全帽时报警
- **结果**: 0=戴安全帽, 1=未戴安全帽

### 6. 吸烟检测 (smoking)
- **功能**: 检测吸烟行为
- **模型**: smoking.rknn
- **阈值**: 连续20帧检测到吸烟时报警（更严格）
- **结果**: 0=无吸烟, 1=检测到吸烟

## 性能优化

### 硬件要求
- **CPU**: 4核以上推荐
- **内存**: 4GB以上
- **存储**: 2GB可用空间
- **摄像头**: 支持红外和RGB摄像头

### 性能调优
1. **调整线程池大小**:
   ```python
   THREAD_POOL_SIZE = 4  # 增加到4（高性能CPU）
   THREAD_POOL_SIZE = 1  # 减少到1（低性能设备）
   ```

2. **调整队列大小**:
   ```python
   FRAME_QUEUE_SIZE = 3      # 减少延迟
   DISPLAY_QUEUE_SIZE = 5    # 减少内存使用
   ```

3. **选择性运行任务**:
   - 只运行必要的检测任务
   - 使用simple_multi_task.py进行选择性控制

### 内存优化
- 帧队列自动丢弃旧帧
- 及时释放模型池资源
- 支持内存使用限制配置

## 故障排除

### 常见问题

#### 1. 摄像头无法打开
**症状**: 显示"无法打开摄像头"错误
**解决方案**:
- 检查摄像头是否被其他程序占用
- 确认`video_number.py`中的摄像头编号配置
- 尝试不同的摄像头编号

#### 2. 模型加载失败
**症状**: 显示"Load RKNN model failed"错误
**解决方案**:
- 确认所有.rknn模型文件存在
- 检查模型文件路径配置
- 验证模型文件完整性

#### 3. 检测效果不佳
**症状**: 检测结果不准确或误报过多
**解决方案**:
- 调整对应任务的置信度阈值
- 修改异常帧阈值
- 改善光照条件
- 调整摄像头位置和角度

#### 4. 程序运行缓慢
**症状**: 帧率过低或响应迟缓
**解决方案**:
- 减少线程池大小
- 降低队列大小
- 只运行必要的检测任务
- 检查系统资源使用情况

#### 5. 内存使用过高
**症状**: 系统内存不足
**解决方案**:
- 减少队列大小
- 降低图像分辨率
- 限制同时运行的任务数量

### 调试模式

启用调试模式获取更多信息：
```python
# 在detection_config.py中设置
DEBUG_CONFIG = {
    'enable_global_debug': True,
    'print_detection_results': True,
    'verbose_logging': True,
}
```

或使用环境变量：
```bash
export DETECTION_MODE=demo
python multi_task_detection.py
```

### 日志记录

系统支持日志记录功能：
```python
ALERT_CONFIG = {
    'enable_log': True,
    'log_file': 'detection_alerts.log',
}
```

## 扩展开发

### 添加新的检测任务

1. **创建检测函数**:
   ```python
   def myFunc_new_task(rknn_lite, img, frame_num):
       # 实现检测逻辑
       return processed_img, detection_result
   ```

2. **添加任务配置**:
   ```python
   'new_task': {
       'model_path': './new_model.rknn',
       'pool_class': rknnPoolExecutor_new,
       'func': myFunc_new_task,
       'camera_type': 'rgb',
       'threshold': 10,
       'window_title': '新任务检测'
   }
   ```

3. **更新结果处理逻辑**:
   在`_process_detection_result`方法中添加新任务的处理逻辑。

### 自定义报警系统

可以扩展报警功能：
```python
def custom_alert_handler(task_name, detection_result):
    if detection_result == 1:  # 检测到异常
        # 发送邮件
        send_email_alert(task_name)
        # 播放声音
        play_alert_sound()
        # 保存截图
        save_alert_image()
```

## 总结

本多任务视觉检测系统提供了：
- ✅ 完整的6任务并行检测能力
- ✅ 灵活的配置和控制选项
- ✅ 智能的资源管理机制
- ✅ 详细的状态监控和调试功能
- ✅ 良好的扩展性和可维护性

无论是用于学习、测试还是生产部署，都能满足不同场景的需求。
