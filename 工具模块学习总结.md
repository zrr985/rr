# 工具模块学习总结

## 概述
本文档总结了视觉检测系统中三个重要工具模块的功能、工作流程和技术特点：
- `add_face.py`: 人脸图片采集工具
- `dect_meter.py`: 仪表检测工具
- `encode.py`: 人脸特征编码工具

## 1. 人脸图片采集工具 (add_face.py)

### 功能描述
通过摄像头实时采集人脸图片，用于构建人脸识别数据库。

### 核心功能
1. **摄像头管理**
   - 自动检测可用的RGB摄像头设备
   - 支持多设备号尝试，确保找到可用摄像头

2. **图片采集**
   - 实时显示摄像头画面
   - 按键控制拍照（'s'键拍照，'q'键退出）
   - 自动编号管理，避免文件名冲突

3. **数据管理**
   - 创建`face_images`文件夹存储图片
   - 维护`name_to_image_map.txt`文件记录图片编号与姓名的对应关系
   - 支持CSV格式的数据记录

### 工作流程
```
启动程序 → 检测摄像头 → 输入姓名 → 实时显示画面 → 按键拍照 → 保存图片和记录 → 退出程序
```

### 技术特点
- **自动化程度高**：自动检测摄像头，自动编号管理
- **用户友好**：实时预览，简单按键操作
- **数据完整性**：同时保存图片和元数据，便于后续处理

## 2. 仪表检测工具 (dect_meter.py)

### 功能描述
使用AprilTag二维码标签技术，自动检测和定位仪表区域，实现仪表的分类识别。

### 核心功能
1. **AprilTag检测**
   - 使用tag36h11编码格式的AprilTag标签
   - 支持多种仪表类型的标签映射
   - 实时检测标签位置和ID

2. **仪表分类**
   - 消防水压表 (ID: 0)
   - 空气房气压表 (ID: 1)
   - 机械气压表 (ID: 2)

3. **ROI提取**
   - 基于对角标签计算仪表区域
   - 自动裁剪仪表ROI图像
   - 返回仪表图像和类别信息

### 工作流程
```
打开摄像头 → 图像预处理 → AprilTag检测 → 标签标注 → 计算ROI → 裁剪仪表区域 → 返回结果
```

### 技术特点
- **高精度定位**：基于AprilTag的精确位置检测
- **多类型支持**：支持多种仪表类型的自动分类
- **可视化标注**：实时显示检测结果和标签信息

### AprilTag技术优势
- **鲁棒性强**：对光照、角度变化有良好的适应性
- **检测精度高**：亚像素级别的定位精度
- **易于部署**：标签制作简单，成本低

## 3. 人脸特征编码工具 (encode.py)

### 功能描述
使用RetinaFace和MobileFaceNet模型，对人脸图片进行特征提取和编码，生成人脸识别数据库。

### 核心功能
1. **人脸检测 (RetinaFace)**
   - 多尺度人脸检测
   - 关键点定位（5个关键点）
   - 非极大值抑制去重

2. **人脸对齐**
   - 基于眼睛关键点的旋转对齐
   - 提高特征提取的准确性

3. **特征提取 (MobileFaceNet)**
   - 深度特征提取
   - 生成128维特征向量
   - 支持人脸相似度计算

### 工作流程
```
读取图片 → RetinaFace检测 → 人脸裁剪 → 关键点对齐 → MobileFaceNet特征提取 → 保存编码
```

### 技术架构

#### RetinaFace模型
- **输入尺寸**: 640×640
- **锚框配置**: 多尺度锚框生成
- **输出**: 边界框、置信度、关键点
- **后处理**: NMS、坐标校正

#### MobileFaceNet模型
- **输入尺寸**: 160×160
- **特征维度**: 128维
- **输出**: 人脸特征向量
- **应用**: 人脸识别和验证

### 关键算法

#### 1. 锚框生成 (Anchors类)
```python
# 多尺度锚框生成
min_sizes = [[16, 32], [64, 128], [256, 512]]
steps = [8, 16, 32]
```

#### 2. 人脸对齐 (Alignment_1函数)
```python
# 基于眼睛关键点的旋转对齐
angle = math.atan(y / x) * 180 / math.pi
```

#### 3. 特征距离计算
```python
# 欧氏距离计算
distance = np.linalg.norm(face_encodings - face_to_compare, axis=1)
```

### 技术特点
- **双模型架构**：检测+特征提取分离设计
- **高精度对齐**：基于关键点的精确对齐
- **高效特征**：128维紧凑特征表示
- **批量处理**：支持多图片批量编码

## 4. 工具模块间的协作关系

### 数据流向
```
add_face.py → face_images/ → encode.py → model_data/
dect_meter.py → 仪表ROI → func_meter.py
```

### 依赖关系
- `add_face.py` → `video_number.py` (摄像头检测)
- `encode.py` → `face_images/` (图片输入)
- `dect_meter.py` → `apriltag` (标签检测)

### 输出文件
- `face_images/`: 人脸图片库
- `name_to_image_map.txt`: 图片-姓名映射
- `model_data/mobilenet_face_encoding.npy`: 人脸特征编码
- `model_data/mobilenet_names.npy`: 人名列表


